<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Chronos</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,700,1,0" />
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <script src="https://momentjs.com/downloads/moment-timezone-with-data.min.js"></script>
    <script src="/assets/gurapp/api/gurasuraisu-api.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --edge-refraction-filter: url('#edge-refraction-only');
            --sun-shadow: 0 0 0 0 transparent;
            
            /* Dark Theme (Default) Variables */
            --background-color-dark: #1c1c1c;
            --background-color-dark-tr: rgba(28, 28, 28, 0.7);
            --text-color-dark: #f9f9f9;
            --secondary-text-color-dark: rgba(255, 255, 255, 0.7);
            --modal-background-dark: rgba(51, 51, 51, 0.8);
            --modal-transparent-dark: rgba(51, 51, 51, 0.7);
            --search-background-dark: rgba(51, 51, 51, 0.5);
            --dark-overlay: rgba(51, 51, 51, 0.2);
            --dark-transparent: rgba(255, 255, 255, 0.1); 
            --glass-border-dark: rgba(100, 100, 100, 0.2);
            
            /* Light Theme Variables */
            --background-color-light: #f0f0f0;
        	--background-color-light-tr: rgba(240, 240, 240, 0.7);
            --text-color-light: #333333;
            --secondary-text-color-light: rgba(0, 0, 0, 0.7);
            --modal-background-light: rgba(220, 220, 220, 0.8);
            --modal-transparent-light: rgba(240, 240, 240, 0.7);
            --search-background-light: rgba(220, 220, 220, 0.5);
            --light-overlay: rgba(220, 220, 220, 0.2);
            --light-transparent: rgba(255, 255, 255, 0.1);
            --glass-border-light: rgba(200, 200, 200, 0.2);
            
            /* Default to Dark Theme */
            --background-color: var(--background-color-dark);
            --background-color-tr: var(--background-color-dark-tr);
            --text-color: var(--text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --modal-background: var(--modal-background-dark);
            --modal-transparent: var(--modal-transparent-dark);
            --search-background: var(--search-background-dark);
            --overlay-color: var(--dark-overlay);
            --transparent-color: var(--dark-transparent);
            --glass-border: var(--glass-border-dark);
        }
        
        body.light-theme {
            --background-color: var(--background-color-light);
            --background-color-tr: var(--background-color-light-tr);
            --text-color: var(--text-color-light);
            --secondary-text-color: var(--secondary-text-color-light);
            --modal-background: var(--modal-background-light);
            --modal-transparent: var(--modal-transparent-light);
            --search-background: var(--search-background-light);
            --overlay-color: var(--light-overlay);
            --transparent-color: var(--light-transparent);
            --glass-border: var(--glass-border-light);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            font-variant-numeric: tabular-nums;
        }

        /* For all clickable elements */
        [onclick], 
        button, 
        a, 
        input[type="button"], 
        input[type="submit"],
        .clickable {
          cursor: pointer;
          transform: scale(1);
          transition: all 0.15s cubic-bezier(0.2, 0, 0.38, 0.9);
        }
        
        /* Active effect (when clicking down) */
        [onclick]:active, 
        button:active, 
        a:active, 
        input[type="button"]:active, 
        input[type="submit"]:active,
        .clickable:active {
          transform: scale(0.96);
          transition: all 0.1s cubic-bezier(0.2, 0, 0.38, 0.9);
          filter: brightness(1.5);
        }
        
        body {
            background-color: var(--background-color-tr);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            user-select: none;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }

        body::-webkit-scrollbar, .modal-content::-webkit-scrollbar {
            width: 8px; /* Thin scrollbar */
        }

        body::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        body::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--search-background);
            border-radius: 25px;
        }
        
        .toolbar {
          display: flex;
          justify-content: center;
          align-content: center;
          flex-direction: row;
          gap: 12px;
          padding: 15px 20px;
          background-color: transparent;
          border: none;
          position: fixed;
          top: 0px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 1000;
          transition: top 0.3s ease;
          width: 100%;
          flex-wrap: wrap;
          height: 80px;
          position: fixed;
        }
        
        .toolbar::before {
          content: "";
          position: absolute;
          inset: 0;
          z-index: -1;
        }
        
        .toolbar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            backdrop-filter: blur(2.5px);
            mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 50%, rgba(0, 0, 0, 0) 100%);
            -webkit-mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 50%, rgba(0, 0, 0, 0) 100%);
        }
        
        .tab-btn {
            background-color: var(--search-background);
            color: transparent;
            border-radius: 25px;
            padding: 12px 16px;
            font-size: 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(.3, 1.2, .64, 1) ! IMPORTANT;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
            border: 1px solid var(--glass-border);
        }
        
        .tab-btn.active {
            background-color: var(--secondary-text-color);
            color: var(--background-color);
            border-radius: 17px;
            font-family: 'Open Runde';
            font-weight: 500;
            padding: 10px 18px 10px 16px;
            font-size: revert;
            gap: 12px;
        }

        .toolbar .tab-btn .material-symbols-rounded {
            transition: color 0.3s;
            color: var(--text-color);
            font-size: 20px;
        }

        .toolbar .tab-btn.active .material-symbols-rounded {
            color: var(--background-color) !important;
        }
          
        .content {
            width: 100%;
        }

        .section {
            gap: 20px;
            flex-direction: column;
        }
        
        /* Alarm Section */
        .alarm-controls {
            display: flex;
            gap: 25px;
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        .time-picker, .timezone-select {
            background-color: var(--search-background);
            border-radius: 28px;
            color: var(--text-color);
            padding: 12px 32px;
            height: 100px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
            border: 1px solid var(--glass-border);
            font-size: 24px;
            font-weight: 500;
        }

        .timezone-select {
            transition: all 0.3s cubic-bezier(.3,1.2,.64,1);
        }

        .timezone-select:focus {
            width: 500px;
        }
        
        .clock-controls:has(.timezone-select:focus) button#addClock.big-action-btn {
            scale: 0;
            width: 0;
            opacity: 0;
        }

        .time-picker {
            width: 250px;
            transition: all 0.3s cubic-bezier(.3,1.2,.64,1);
        }

        .time-picker:focus {
            width: 500px;
        }
        
        .alarm-controls:has(.time-picker:focus) button#addAlarm.big-action-btn {
            scale: 0;
            width: 0;
            opacity: 0;
        }
        
        .alarm-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .alarm-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--search-background);
            padding: 12px 12px 12px 28px;
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
            font-size: 24px;
        }
        
        /* Timer Section */
        .timer-circle {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 180px;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }
        
        .progress-ring circle:first-child {
            stroke: var(--search-background);
        }
        
        .progress-ring circle.progress {
            stroke: var(--text-color);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }
        
        .timer-display {
            position: absolute;
            font-size: 10vw;
            cursor: pointer;
            user-select: none;
            font-family: 'Inter Numeric', 'Inter';
            font-variation-settings: "RDNS" 1;
            font-weight: bold;
        }
        
        .timer-input {
            position: absolute;
            font-size: 48px;
            background: transparent;
            border: none;
            color: var(--text-color);
            text-align: center;
            width: 200px;
            display: none;
        }
        
        .timer-input:focus {
            outline: none;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        .controls .btn {
            background-color: var(--search-background);
            color: var(--text-color);
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
            border: 1px solid var(--glass-border);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        /* Stopwatch Section */
        .stopwatch-display {
            font-size: 12vw;
            text-align: center;
            margin: 20px 0;
            font-family: 'Inter Numeric', 'Inter';
            font-variation-settings: "RDNS" 1;
            font-weight: bold;
        }
        
        .stopwatch-controls {
            display: flex;
            justify-content: center;
            gap: 25px;
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .lap-list {
            overflow-y: auto;
            margin-bottom: 180px;
        }
        
        .lap-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 2px solid var(--search-background);
        }
        
        /* World Clock Section */
        .clock-controls {
            display: flex;
            gap: 25px;
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        .clock-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .clock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--search-background);
            padding: 12px 12px 12px 28px;
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
        }
        
        .material-symbols-rounded {
            font-size: 24px;
            color: var(--text-color);
        }
        
        .action-btn {
            background-color: var(--search-background);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
            font-weight: 500;
        }

        .clear-action-btn {
            background-color: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 50px;
            padding: 12px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: none;
            box-shadow: none;
            font-weight: 500;
        }
        
        .big-action-btn {
            background-color: var(--search-background);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 100px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(5px) saturate(2) var(--edge-refraction-filter);
            box-shadow: var(--sun-shadow);
            font-weight: 500;
            width: 100px;
            height: 100px;
        }

        .big-action-btn .material-symbols-rounded {
            font-size: 34px;
        }

        @media (max-width: 730px) {
            .toolbar {
                justify-content: flex-start;
            }
            
            .tab-btn {
                font-size: 0;
                padding: 12px 16px;
                gap: 0 !important;
            }
        
            .tab-btn.active {
                font-size: 0;
                padding: 12px 24px;
            }

            .timer-circle {
                transform: scale(0.8);
            }

            .timer-display, .timer-input {
                font-size: 36px;
            }
        }
    </style>
</head>
<body data-app-name="CHRONOS">
    <svg style="display: none">
        <filter id="edge-refraction-only" color-interpolation-filters="linearRGB">
            <!-- Part 1: Create the turbulence noise that will displace the pixels -->
            <feTurbulence type="fractalNoise" baseFrequency="0.01 0.04" numOctaves="2" result="turbulence"></feTurbulence>
        
            <!-- Part 2: Create a mask that is only opaque at the very edges of the source graphic -->
            <feMorphology in="SourceGraphic" operator="erode" radius="4" result="eroded"></feMorphology>
            <feComposite in="SourceGraphic" in2="eroded" operator="out" result="border_mask"></feComposite>
        
            <!-- Part 3: Apply the turbulence only to the edge mask -->
            <feComposite in="turbulence" in2="border_mask" operator="in" result="edge_turbulence"></feComposite>
        
            <!-- Part 4: Create a displacement map that is neutral (50% gray) in the center
                 and has the turbulence pattern at the edges. This prevents the center of the
                 graphic from being distorted. -->
            <feFlood flood-color="#808080" result="neutral_base"></feFlood>
            <feMerge result="displacement_map">
                <feMergeNode in="neutral_base"></feMergeNode>
                <feMergeNode in="edge_turbulence"></feMergeNode>
            </feMerge>
        
            <!-- Part 5: Apply the displacement twice and combine the results. -->
            <!-- Pass 1: A positive scale refracts the top and left edges inward correctly. -->
            <feDisplacementMap in="SourceGraphic" in2="displacement_map" scale="30" xChannelSelector="R" yChannelSelector="G" result="disp_positive"></feDisplacementMap>
            
            <!-- Pass 2: A negative scale refracts the bottom and right edges inward correctly. -->
            <feDisplacementMap in="SourceGraphic" in2="displacement_map" scale="-30" xChannelSelector="R" yChannelSelector="G" result="disp_negative"></feDisplacementMap>
            
            <!-- Part 6: Blend the two results. The 'lighten' mode takes the non-transparent pixels
                 from both passes. Since the "incorrect" refractions are pushed into transparent
                 areas, this effectively combines the correctly refracted edges from both passes. -->
            <feBlend in="disp_positive" in2="disp_negative" mode="lighten"></feBlend>
        </filter>
    </svg>
    
    <div class="content">
        <div class="toolbar">
            <button class="tab-btn active" data-tab="alarm">
                <span class="material-symbols-rounded">alarm</span>
                Alarm
            </button>
            <button class="tab-btn" data-tab="timer">
                <span class="material-symbols-rounded">hourglass_empty</span>
                Timer
            </button>
            <button class="tab-btn" data-tab="stopwatch">
                <span class="material-symbols-rounded">timer</span>
                Stopwatch
            </button>
            <button class="tab-btn" data-tab="worldclock">
                <span class="material-symbols-rounded">public</span>
                Worlds
            </button>
        </div>
        
        <!-- Alarm Section -->
        <div id="alarm" class="section">
            <div class="alarm-controls">
                <input type="time" class="time-picker" id="alarmTime">
                <button class="big-action-btn" id="addAlarm">
                    <span class="material-symbols-rounded">add</span>
                </button>
            </div>
            <div class="alarm-list" id="alarmList"></div>
        </div>
        
        <!-- Timer Section -->
        <div id="timer" class="section" style="display: none;">
            <div class="timer-circle">
                <svg class="progress-ring" width="500" height="500">
                    <circle cx="250" cy="250" r="240" />
                    <circle class="progress" cx="250" cy="250" r="240" />
                </svg>
                <div class="timer-display" id="display">00:00</div>
                <input type="text" class="timer-input" id="timeInput" maxlength="4" pattern="\d*">
            </div>
            <div class="controls">
                <button class="btn" onclick="addTime(30)">30s</button>
                <button class="btn" onclick="addTime(60)">1m</button>
                <button class="btn" onclick="addTime(300)">5m</button>
                <button class="btn" onclick="addTime(1800)">30m</button>
            </div>
            <div class="action-buttons">
                <button class="big-action-btn running" id="startBtn" onclick="toggleTimer()">
                    <span class="material-symbols-rounded">play_arrow</span>
                </button>
                <button class="big-action-btn running" id="resetBtn" onclick="resetTimer()">
                    <span class="material-symbols-rounded">restart_alt</span>
                </button>
            </div>
        </div>
        
        <!-- Stopwatch Section -->
        <div id="stopwatch" class="section" style="display: none;">
            <div class="stopwatch-display" id="stopwatchDisplay">00:00:00.000</div>
            <div class="stopwatch-controls">
                <button class="big-action-btn" id="startStopwatch">
                    <span class="material-symbols-rounded">play_arrow</span>
                </button>
                <button class="big-action-btn" id="lapStopwatch">
                    <span class="material-symbols-rounded">flag</span>
                </button>
                <button class="big-action-btn" id="resetStopwatch">
                    <span class="material-symbols-rounded">restart_alt</span>
                </button>
            </div>
            <div class="lap-list" id="lapList"></div>
        </div>
        
        <!-- World Clock Section -->
        <div id="worldclock" class="section" style="display: none;">
            <div class="clock-controls">
                <select class="timezone-select" id="timezoneSelect"></select>
                <button class="big-action-btn" id="addClock">
                    <span class="material-symbols-rounded">add</span>
                </button>
            </div>
            <div class="clock-list" id="clockList"></div>
        </div>
    </div>

    <script>
        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
                document.getElementById(button.dataset.tab).style.display = 'flex';
            });
        });

        // Timer Variables
        let totalTime = 0;
        let timeLeft = 0;
        let timerId = null;
        const display = document.getElementById('display');
        const timeInput = document.getElementById('timeInput');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const progressRing = document.querySelector('.progress-ring');
        const progressCircle = document.querySelector('.progress-ring circle.progress');
        const timerContainer = document.querySelector('.timer-container');
        const quickTimeControls = document.querySelector('.controls');

        // Load the MP3 sound for the timer alarm
        const timerAlarmSound = new Audio('https://www.gstatic.com/delight/funbox/timer_utilitarian_v2.mp3');

        const radius = progressCircle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;

        function setProgress(percent) {
            const offset = circumference - (percent / 150 * circumference);
            progressCircle.style.strokeDashoffset = offset;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            const percent = totalTime > 0 ? Math.min(100, Math.max(0, (timeLeft / totalTime) * 100)) : 0;
            display.textContent = formatTime(timeLeft);
            setProgress(percent);
            progressRing.classList[timeLeft > 0 ? 'add' : 'remove']('active');
        }

        function addTime(seconds) {
            let wasRunning = !!timerId;
            if (timerId) { 
                clearInterval(timerId); 
                timerId = null; 
                startBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>'; 
            }
            timeLeft += seconds;
            if (!wasRunning) totalTime = timeLeft;
            totalTime = Math.max(totalTime, timeLeft);
            updateDisplay(); 
            updateActionButtons();
        }

        function toggleTimer() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
                startBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>';
            } else {
                if (timeLeft > 0) {
                    timerId = setInterval(() => {
                        timeLeft--;
                        updateDisplay();
                        if (timeLeft <= 0) {
                            clearInterval(timerId);
                            timerId = null;
                            startBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>';
                            playTimerAlarm();
                        }
                    }, 1000);
                    startBtn.innerHTML = '<span class="material-symbols-rounded">pause</span>';
                }
            }
            updateActionButtons();
        }

        function updateActionButtons() {
            const isTimerAlarmPlaying = timerAlarmSound.currentTime > 0 && !timerAlarmSound.paused;
            if (timeLeft === 0 && isTimerAlarmPlaying){
                startBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                quickTimeControls.style.display = 'flex';
            } else if (timeLeft === 0 && !isTimerAlarmPlaying){
                startBtn.style.display = 'none';
                resetBtn.style.display = 'block';
                quickTimeControls.style.display = 'flex';
            } else if (timeLeft > 0){
                startBtn.style.display = 'block';
                resetBtn.style.display = 'block';
                quickTimeControls.style.display = 'none';
            } else {
                startBtn.style.display = 'block';
                resetBtn.style.display = 'none';
                quickTimeControls.style.display = 'flex';
            }
        }

        function resetTimer() {
            if (timerId) clearInterval(timerId);
            timerId = null; 
            timeLeft = 0; 
            totalTime = 0; 
            updateDisplay(); 
            startBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>';
            timerAlarmSound.pause(); 
            timerAlarmSound.currentTime = 0; 
            updateActionButtons();
        }

        function playTimerAlarm() {
            timerAlarmSound.play();
            updateActionButtons();

            // Send notification via Gurasuraisu API with a button that calls a Gurapp function
            Gurasuraisu.showNotification("Timer", {
                icon: "hourglass", // Use a Material Symbols icon
                buttonText: "Dismiss",
                gurappAction: {
                    appName: document.body.dataset.appName, // Get the app name from the body data-attribute
                    functionName: "dismissTimerNotification", // Function to call in this Gurapp
                    args: [] // Any arguments for that function (e.g., timer ID if multiple timers)
                }
            });

            // Native browser notification (optional, as Gurasuraisu's own handles it)
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("⏰ Timer Finished", {
                    body: "Your timer has finished!",
                    icon: "favicon.png"
                });
            }
        }

        display.addEventListener('click', () => {
            timeInput.value = formatTime(timeLeft).replace(':', '');
            timeInput.style.display = 'block'; 
            display.style.display = 'none'; 
            timeInput.focus(); 
            updateActionButtons();
        });

        timeInput.addEventListener('blur', () => {
            const input = timeInput.value.padStart(4, '0');
            const minutes = parseInt(input.slice(0, -2), 10);
            const seconds = parseInt(input.slice(-2), 10);
            if (!isNaN(minutes) && !isNaN(seconds)) { 
                timeLeft = minutes * 60 + seconds; 
                totalTime = timeLeft; 
            }
            updateDisplay(); 
            updateActionButtons(); 
            timeInput.style.display = 'none'; 
            display.style.display = 'block';
        });

        timeInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') timeInput.blur(); 
        });

        updateActionButtons();

        // Alarm Functionality
        let originalTitle = document.title;
        let alarms = JSON.parse(localStorage.getItem('alarms')) || [];

        function saveAlarms() {
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }
          
        document.getElementById('addAlarm').addEventListener('click', () => {
            const time = document.getElementById('alarmTime').value;
            if (time) {
                alarms.push({ time, id: Date.now() });
                saveAlarms();
                renderAlarms();
                checkAlarms();
            }
        });
            
        // Create audio element for alarms
        const alarmSound = new Audio('https://www.gstatic.com/delight/funbox/timer_utilitarian_v2.mp3');
        alarmSound.loop = true;

        if ("Notification" in window) {
           Notification.requestPermission();
        }
            
        function checkAlarms() {
            const now = new Date();
            const currentTime = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit'
            });

            alarms.forEach(alarm => {
                if (alarm.time === currentTime) {
                    triggerAlarm(alarm.time);
                    deleteAlarm(alarm.id);
                }
            });
        }

        function triggerAlarm(alarmTime) {
           alarmSound.play();

           // The native notification will be dismissed by the user or the OS.
           // Gurasuraisu's popup will have a dismiss button.
           // Do NOT call stopAlarm() here directly, as the user needs to dismiss it.
           
           setTimeout(stopAlarm, 60000); // Auto-stop after 1 minute if not dismissed

           document.title = "⏰ Alarm";
           
           // Send notification via Gurasuraisu API with a button that calls a Gurapp function
           Gurasuraisu.showNotification(`Alarm • ${alarmTime}`, {
               icon: "alarm", // Material Symbols icon for active alarm
               buttonText: "Dismiss",
               gurappAction: {
                   appName: document.body.dataset.appName, // "Chronos"
                   functionName: "dismissAlarmNotification", // Function to call in this Gurapp
                   args: [] 
               }
           });
            
           // Native browser notification (optional, as Gurasuraisu's own handles it)
           if ("Notification" in window && Notification.permission === "granted") {
               new Notification("⏰ Alarm", {
                   body: alarmTime,
                   icon: "favicon.png" // Path to Chronos favicon
               });
           }
        }
                      
        function stopAlarm() {
            alarmSound.pause();
            alarmSound.currentTime = 0;
            document.title = originalTitle;
            
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        setInterval(checkAlarms, 1000);

        function renderAlarms() {
            const alarmList = document.getElementById('alarmList');
            alarmList.innerHTML = alarms.map(alarm => `
                <div class="alarm-item">
                    <span>${alarm.time}</span>
                    <button class="clear-action-btn" onclick="deleteAlarm(${alarm.id})">
                        <span class="material-symbols-rounded">cancel</span>
                    </button>
                </div>
            `).join('');
        }

        function deleteAlarm(id) {
            alarms = alarms.filter(alarm => alarm.id !== id);
            saveAlarms();
            renderAlarms();
        }

        // Stopwatch Functionality
        let stopwatchTime = 0;
        let stopwatchInterval;
        let laps = [];
        let isRunning = false;

        document.getElementById('startStopwatch').addEventListener('click', function() {
            if (!isRunning) {
                this.innerHTML = '<span class="material-symbols-rounded">pause</span>';
                stopwatchInterval = setInterval(updateStopwatch, 10);
            } else {
                this.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>';
                clearInterval(stopwatchInterval);
            }
            isRunning = !isRunning;
        });

        function updateStopwatch() {
            stopwatchTime += 10;
            const display = document.getElementById('stopwatchDisplay');
            display.textContent = formatStopwatchTime(stopwatchTime);
        }

        function formatStopwatchTime(ms) {
            const date = new Date(ms);
            return date.toISOString().substr(11, 12);
        }

        document.getElementById('lapStopwatch').addEventListener('click', () => {
            if (isRunning) {
                laps.push(stopwatchTime);
                renderLaps();
            }
        });
        
        function renderLaps() {
            const lapList = document.getElementById('lapList');
            lapList.innerHTML = laps.map((lap, index) => `
                <div class="lap-item">
                    <span>Lap ${index + 1}</span>
                    <span>${formatStopwatchTime(lap)}</span>
                </div>
            `).join('');
        }

       document.getElementById('resetStopwatch').addEventListener('click', () => {
           clearInterval(stopwatchInterval);
           stopwatchTime = 0;
           laps = [];
           isRunning = false;
           document.getElementById('stopwatchDisplay').textContent = '00:00:00.000';
           document.getElementById('startStopwatch').innerHTML = '<span class="material-symbols-rounded">play_arrow</span>';
           renderLaps();
       });

       // World Clock Functionality
       let worldClocks = JSON.parse(localStorage.getItem('worldClocks')) || [];

       function saveWorldClocks() {
           localStorage.setItem('worldClocks', JSON.stringify(worldClocks));
       }

       // Populate timezone select
       const timezones = moment.tz.names();
       const timezoneSelect = document.getElementById('timezoneSelect');
       timezones.forEach(timezone => {
           const option = document.createElement('option');
           option.value = timezone;
           option.textContent = timezone;
           timezoneSelect.appendChild(option);
       });

       document.getElementById('addClock').addEventListener('click', () => {
           const timezone = timezoneSelect.value;
           if (timezone && !worldClocks.find(clock => clock.timezone === timezone)) {
               worldClocks.push({ timezone, id: Date.now() });
               saveWorldClocks();
               renderWorldClocks();
           }
       });
       
       function renderWorldClocks() {
           const clockList = document.getElementById('clockList');
           clockList.innerHTML = worldClocks.map(clock => `
               <div class="clock-item">
                   <div>
                       <div>${clock.timezone}</div>
                       <div>${moment().tz(clock.timezone).format('HH:mm:ss')}</div>
                   </div>
                   <button class="clear-action-btn" onclick="deleteClock(${clock.id})">
                       <span class="material-symbols-rounded">cancel</span>
                   </button>
               </div>
           `).join('');
       }

       function deleteClock(id) {
           worldClocks = worldClocks.filter(clock => clock.id !== id);
           saveWorldClocks();
           renderWorldClocks();
       }
        
        // This function will stop the alarm sound and reset the timer UI.
        function dismissTimerNotification() {
            // Re-use existing stopAlarm logic
            stopAlarm(); 
            // Also ensure timer state is reset if it's not already
            resetTimer(); 
        }

        function dismissAlarmNotification() {
            stopAlarm(); // Re-use existing stopAlarm logic
        }

        // Listener for messages from the parent (Gurasuraisu) to trigger specific actions
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return; // Security check

            const data = event.data;

            // Check if this is a request from the parent to execute a Gurapp action
            if (data && data.type === 'gurapp-action-request' && data.functionName) {
                const func = window[data.functionName]; // Get the function by name

                if (typeof func === 'function') {
                    func.apply(window, data.args || []); // Execute the function with its arguments
                } else {
                    console.warn(`Chronos Gurapp: Function '${data.functionName}' not found or not callable.`);
                }
            }
            // Other message types (like themeUpdate, animationsUpdate) are handled by gurasuraisu-api.js
        });

        // Make the functions globally accessible for the message listener
        window.dismissTimerNotification = dismissTimerNotification;
        window.dismissAlarmNotification = dismissAlarmNotification;

       // Update world clocks every second
       setInterval(renderWorldClocks, 1000);

       renderAlarms();
       renderWorldClocks();
   </script>
</body>
</html>
